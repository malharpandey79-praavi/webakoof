<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#050814" />
    <title>Blog Post | Webakoof</title>
    <meta name="description" content="Read insights from the Webakoof blog." />
    <link rel="canonical" href="" />

    <meta property="og:site_name" content="Webakoof" />
    <meta property="og:title" content="Blog Post | Webakoof" />
    <meta
      property="og:description"
      content="Read insights from the Webakoof blog."
    />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="" />
    <meta property="og:image" content="" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Blog Post | Webakoof" />
    <meta
      name="twitter:description"
      content="Read insights from the Webakoof blog."
    />
    <meta name="twitter:image" content="" />

    <link rel="stylesheet" href="/styles/base/reset.css" />
    <link rel="stylesheet" href="/styles/base/variables.css" />
    <link rel="stylesheet" href="/styles/base/typography.css" />
    <link rel="stylesheet" href="/styles/layout/layout-shell.css" />
    <style>
      .reading-progress {
        position: fixed;
        inset-inline: 0;
        top: 0;
        height: 3px;
        z-index: 40;
        pointer-events: none;
      }

      .reading-progress__bar {
        width: 100%;
        height: 100%;
        transform-origin: left center;
        transform: scaleX(0);
        background: var(--accent-primary);
        opacity: 0;
        transition:
          transform var(--duration-fast) var(--ease-smooth),
          opacity var(--duration-fast) var(--ease-smooth);
      }

      .reading-progress__bar--active {
        opacity: 1;
      }

      @media (prefers-reduced-motion: reduce) {
        .reading-progress__bar {
          transition: none;
        }
      }
    </style>
    <script src="https://unpkg.com/snarkdown@2.0.0/dist/snarkdown.umd.js"></script>
  </head>
  <body>
    <div class="reading-progress">
      <div class="reading-progress__bar" id="reading-progress-bar"></div>
    </div>
    <header class="site-header">
      <div class="layout-shell site-header__inner">
        <a href="/" class="site-header__logo">Webakoof</a>
        <nav class="site-header__nav" aria-label="Primary navigation">
          <a href="/" class="site-header__link">Home</a>
          <a href="/blog.html" class="site-header__link">Blog</a>
        </nav>
      </div>
    </header>

    <main class="page-main">
      <section class="section">
        <div class="layout-shell">
          <article id="post" class="blog-post" aria-live="polite">
            <p id="post-status">Loading article…</p>
          </article>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="layout-shell site-footer__inner">
        <p class="site-footer__copy">
          &copy; <span id="footer-year"></span> Webakoof. All rights reserved.
        </p>
      </div>
    </footer>

    <script>
      (function () {
        const postContainer = document.getElementById("post");
        const statusEl = document.getElementById("post-status");
        const progressBar = document.getElementById("reading-progress-bar");

        let progressStart = 0;
        let progressEnd = 0;
        let progressEnabled = false;

        function updateProgress() {
          if (!progressEnabled || !progressBar) return;
          const y = window.scrollY || window.pageYOffset || 0;
          if (y <= progressStart) {
            progressBar.style.transform = "scaleX(0)";
            return;
          }
          const ratio = Math.min(
            Math.max((y - progressStart) / (progressEnd - progressStart || 1), 0),
            1
          );
          progressBar.style.transform = `scaleX(${ratio})`;
        }

        function computeProgressBounds() {
          if (!postContainer || !progressBar) return;

          const articleHeight = postContainer.offsetHeight;
          const viewportHeight =
            window.innerHeight || document.documentElement.clientHeight || 0;

          // Hide progress for very short articles
          if (articleHeight <= viewportHeight + 16) {
            progressEnabled = false;
            progressBar.classList.remove("reading-progress__bar--active");
            progressBar.style.transform = "scaleX(0)";
            return;
          }

          const rect = postContainer.getBoundingClientRect();
          const scrollY = window.scrollY || window.pageYOffset || 0;
          const articleTop = rect.top + scrollY;

          progressStart = articleTop - 16;
          progressEnd = articleTop + articleHeight - viewportHeight;

          if (progressEnd <= progressStart) {
            progressEnabled = false;
            progressBar.classList.remove("reading-progress__bar--active");
            progressBar.style.transform = "scaleX(0)";
            return;
          }

          progressEnabled = true;
          progressBar.classList.add("reading-progress__bar--active");
          updateProgress();
        }

        function setupReadingProgress() {
          if (!progressBar || !postContainer) return;

          computeProgressBounds();

          window.addEventListener("scroll", updateProgress, { passive: true });
          window.addEventListener("resize", computeProgressBounds);
        }

        function getSlugFromQuery() {
          const params = new URLSearchParams(window.location.search);
          return params.get("slug");
        }

        function parseFrontmatter(text) {
          const delimiter = "---";
          if (!text.startsWith(delimiter)) {
            return { frontmatter: {}, body: text };
          }

          const end = text.indexOf(delimiter, delimiter.length);
          if (end === -1) {
            return { frontmatter: {}, body: text };
          }

          const rawFront = text.slice(delimiter.length, end).trim();
          const body = text.slice(end + delimiter.length).trim();
          const frontmatter = {};

          rawFront.split("\n").forEach((line) => {
            const idx = line.indexOf(":");
            if (idx === -1) return;
            const key = line.slice(0, idx).trim();
            const value = line.slice(idx + 1).trim();
            if (!key) return;
            frontmatter[key] = value.replace(/^["']|["']$/g, "");
          });

          return { frontmatter, body };
        }

        function formatDate(value) {
          if (!value) return "";
          const d = new Date(value);
          if (Number.isNaN(d.getTime())) return value;
          return d.toLocaleDateString("en-IN", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
        }

        async function loadPostBySlug(slug) {
          // We try the obvious filename convention first.
          const candidates = [`${slug}.md`];

          for (const name of candidates) {
            const res = await fetch(`/content/blog/${name}`, { cache: "no-store" });
            if (res.ok) {
              const text = await res.text();
              const parsed = parseFrontmatter(text);
              return { ...parsed, filename: name };
            }
          }

          throw new Error("Post not found");
        }

        function renderPost(frontmatter, body) {
          if (statusEl) statusEl.remove();

          const titleEl = document.createElement("h1");
          titleEl.className = "blog-post__title";
          titleEl.textContent = frontmatter.title || "Untitled post";

          const metaEl = document.createElement("p");
          metaEl.className = "blog-post__meta";
          const dateText = formatDate(frontmatter.date);
          metaEl.textContent = dateText || "";

          const descEl = document.createElement("p");
          descEl.className = "blog-post__description";
          descEl.textContent = frontmatter.description || "";

          const bodyEl = document.createElement("div");
          bodyEl.className = "blog-post__body";

          if (window.snarkdown && typeof window.snarkdown === "function") {
            bodyEl.innerHTML = window.snarkdown(body);
          } else {
            // Fallback: very basic formatting
            bodyEl.textContent = body;
          }

          postContainer.appendChild(titleEl);
          if (metaEl.textContent) postContainer.appendChild(metaEl);
          if (descEl.textContent) postContainer.appendChild(descEl);
          postContainer.appendChild(bodyEl);
        }

        async function init() {
          const yearSpan = document.getElementById("footer-year");
          if (yearSpan) {
            yearSpan.textContent = String(new Date().getFullYear());
          }

          const slug = getSlugFromQuery();
          if (!slug) {
            if (statusEl) {
              statusEl.textContent = "No article specified. Use a link from the blog list.";
            }
            return;
          }

          try {
            const { frontmatter, body } = await loadPostBySlug(slug);
            renderPost(frontmatter, body);

            // Dynamic SEO meta based on frontmatter
            const fallbackTitle = "Blog Post | Webakoof";
            const fallbackDescription = "Read insights from the Webakoof blog.";

            const title = frontmatter.title
              ? frontmatter.title + " | Webakoof"
              : fallbackTitle;
            const description = frontmatter.description || fallbackDescription;
            const cover = frontmatter.cover || "";

            document.title = title;

            const canonicalUrl =
              window.location.origin +
              window.location.pathname +
              window.location.search;

            const metaDescription = document.querySelector(
              'meta[name="description"]'
            );
            const linkCanonical = document.querySelector(
              'link[rel="canonical"]'
            );
            const ogTitle = document.querySelector('meta[property="og:title"]');
            const ogDescription = document.querySelector(
              'meta[property="og:description"]'
            );
            const ogUrl = document.querySelector('meta[property="og:url"]');
            const ogImage = document.querySelector('meta[property="og:image"]');
            const twitterTitle = document.querySelector(
              'meta[name="twitter:title"]'
            );
            const twitterDescription = document.querySelector(
              'meta[name="twitter:description"]'
            );
            const twitterImage = document.querySelector(
              'meta[name="twitter:image"]'
            );

            if (metaDescription) metaDescription.content = description;
            if (linkCanonical) linkCanonical.href = canonicalUrl;
            if (ogTitle) ogTitle.content = title;
            if (ogDescription) ogDescription.content = description;
            if (ogUrl) ogUrl.content = canonicalUrl;
            if (ogImage && cover) ogImage.content = cover;
            if (twitterTitle) twitterTitle.content = title;
            if (twitterDescription)
              twitterDescription.content = description;
            if (twitterImage && cover) twitterImage.content = cover;

            // Hint browsers to lazy-load article images where supported
            const images = postContainer.querySelectorAll("img");
            images.forEach((img) => {
              img.loading = "lazy";
              img.decoding = "async";
            });

            // Reading progress is only meaningful once the article renders.
            setupReadingProgress();
          } catch (error) {
            console.error(error);
            if (statusEl) {
              statusEl.textContent =
                "We couldn’t find that article. It may have been moved or unpublished.";
            }
          }
        }

        document.addEventListener("DOMContentLoaded", init);
      })();
    </script>
  </body>
</html>

